<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ç·šä¸Šæ³¡èŒ¶é¬§é˜</title>
<style>
body { font-family:sans-serif; max-width:800px; margin:20px auto; text-align:center;}
table { width:100%; border-collapse: collapse; margin-top:10px;}
th, td { border:1px solid #aaa; padding:5px; text-align:center;}
input[type="number"]{ width:70px; }
button{ margin:5px; padding:6px 12px;}
#countdown { font-size:2em; margin-top:15px; color:#006600;}
#manualCountdown { font-size:1.8em; margin-top:10px; color:#003366;}
fieldset { border:1px solid #ccc; padding:10px; margin-top:25px;}
legend { padding:0 6px;}
textarea { resize:none; }
.flex-row { display:flex; align-items:flex-start; gap:20px; margin-top:10px;}
</style>
</head>
<body>

<h1>ğŸµ æ³¡èŒ¶é¬§é˜</h1>

<!-- ========= è‡ªå‹•èŒ¶è­œç‰ˆæœ¬ ========= -->
<div>
    <label>
        èŒ¶è­œåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›çš„ç½®èŒ¶é‡ã€æ˜¯å¦è¦æº«æ½¤æ³¡ã€æ²–æ³¡æ™‚é–“ã€å›æ²–æ¬¡æ•¸ç­‰ã€è«‹ä¾å€‹äººå–œå¥½èˆ‡ç¿’æ…£èª¿æ•´ã€‚</br>
        èª¿æ•´å¥½å¾Œçš„èŒ¶è­œå¯ä»¥åŒ¯å‡ºå†åŒ¯å…¥è¨‚è£½è‡ªå·±çš„æ³¡èŒ¶é£Ÿè­œã€‚</br>
        </br>
    </label>
    <label>é è¨­èŒ¶è­œï¼š
        <select id="preset">
            <option value="">--è«‹é¸æ“‡--</option>
            <option value="ç´…èŒ¶">ç´…èŒ¶</option>
            <option value="æ±æ–¹ç¾äººèŒ¶">æ±æ–¹ç¾äººèŒ¶</option>
            <option value="é«˜å±±èŒ¶">é«˜å±±èŒ¶</option>
            <option value="å‡é ‚çƒé¾èŒ¶">å‡é ‚çƒé¾èŒ¶</option>
        </select>
    </label>
    <div style="margin-top:10px;">
        <button id="exportBtn">åŒ¯å‡º è¨­å®šæª”</button>
        åŒ¯å…¥è¨­å®šæª”
        <input type="file" id="importFile" accept=".json">
    </div>
</div>

<div class="flex-row">
    <div>
        <label>ç¬¬ä¸€æ³¡(ç§’)ï¼š<input type="number" id="first" value="30" min="1"></label>
        <label>æ¯æ³¡å¢åŠ (ç§’)ï¼š<input type="number" id="increment" value="15" min="0"></label>
        <button id="generateBtn">ç”¢ç”Ÿæ™‚é–“è¡¨</button>
    </div>
    <div>
        <label>èŒ¶æ³¨æ„äº‹é …ï¼š</label><br>
        <textarea id="teaNote" rows="6" cols="30" placeholder="é€™è£¡é¡¯ç¤ºèŒ¶çš„æ³¨æ„äº‹é …..."></textarea>
    </div>
</div>

<table id="timeTable">
    <thead><tr><th>æ³¡æ•¸</th><th>æ™‚é–“(ç§’)</th></tr></thead>
    <tbody></tbody>
</table>

<div>
    <button id="addBatchBtn">â• æ–°å¢ä¸€æ³¡</button>
    <button id="removeBatchBtn">â– æ¸›å°‘ä¸€æ³¡</button>
</div>

<hr>
<h2>â³ è‡ªå‹•è¨ˆæ™‚</h2>
<div>
    <button id="startBtn">â–¶ é–‹å§‹</button>
    <button id="nextBtn" disabled>â¡ ä¸‹ä¸€æ³¡</button>
    <button id="stopBtn">â¹ åœæ­¢</button>
</div>
<div id="countdown">å°šæœªé–‹å§‹</div>

<audio id="alarmSound">
    <source src="bell_notify.mp3" type="audio/mpeg">
    ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³æ•ˆæ’­æ”¾
</audio>

<!-- ========= æ‰‹å‹•è¨ˆæ™‚ç‰ˆæœ¬ ========= -->
<fieldset>
    <legend>ğŸ”§ æ‰‹å‹•å–®æ¬¡è¨ˆæ™‚</legend>
    <div>
        <label>ç§’æ•¸ï¼š
            <input type="number" id="manualSec" value="60" min="1">
        </label>
        <button id="manualStart">â–¶ é–‹å§‹</button>
        <button id="manualStop">â¹ åœæ­¢</button>
    </div>
    <div id="manualCountdown">å°šæœªé–‹å§‹</div>
</fieldset>

<script>
const presets={
    "ç´…èŒ¶"      :[60,70,80,85,90,95,100],
    "æ±æ–¹ç¾äººèŒ¶":[60,70,80,85,90,95,100],
    "é«˜å±±èŒ¶"    :[50,60,70,75,80,85,90],
    "å‡é ‚çƒé¾èŒ¶":[50,60,70,75,80,85,90],
};

const teaNotes = {
    "ç´…èŒ¶"      : "æ°´æº«90-92,1g:50ml",
    "æ±æ–¹ç¾äººèŒ¶": "æ°´æº«90-92,1g:50ml",
    "é«˜å±±èŒ¶"    : "æ°´æº«95-100,10g:200ml",
    "å‡é ‚çƒé¾èŒ¶": "æ°´æº«95-100,10g:200ml"
};

const tbody = document.querySelector("#timeTable tbody");
const countdownEl = document.getElementById("countdown");
const alarm = document.getElementById("alarmSound");
const presetSel = document.getElementById("preset");
const firstInput = document.getElementById("first");
const incrementInput = document.getElementById("increment");
const startBtn = document.getElementById("startBtn");
const nextBtn = document.getElementById("nextBtn");
const stopBtn = document.getElementById("stopBtn");
const generateBtn = document.getElementById("generateBtn");
const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");
const addBatchBtn = document.getElementById("addBatchBtn");
const removeBatchBtn = document.getElementById("removeBatchBtn");
const teaNoteInput = document.getElementById("teaNote");

let timer = null;
let currentIndex = 0;
let times = [];

function fillTable(arr){
    tbody.innerHTML="";
    arr.forEach((sec,i)=>{
        const tr = document.createElement("tr");
        const input = document.createElement("input");
        input.type = "number";
        input.value = sec;
        input.min = 0;
        input.style.width = "70px";
        input.addEventListener("input", ()=>{
            if(times[i] !== undefined){
                times[i] = parseInt(input.value) || 0;
            }
        });
        tr.innerHTML = `<td>ç¬¬${i+1}æ³¡</td>`;
        const td = document.createElement("td");
        td.appendChild(input);
        tr.appendChild(td);
        tbody.appendChild(tr);
    });
}

function generate(){
    const first = parseInt(firstInput.value) || 0;
    const inc = parseInt(incrementInput.value) || 0;
    const arr=[];
    const rows = tbody.querySelectorAll("tr");
    let length = rows.length || 10;
    for(let i=0;i< length;i++) arr.push(first + i*inc);
    fillTable(arr);
}

function getTimes(){
    return Array.from(tbody.querySelectorAll("input")).map(i=>parseInt(i.value)||0);
}

function startTimer(){
    stopTimer();
    times = getTimes();
    currentIndex = 0;
    startBtn.disabled = true;
    nextBtn.disabled = true;
    runCurrent();
}

function runCurrent(){
    if(currentIndex >= times.length){
        countdownEl.textContent = "å…¨éƒ¨å®Œæˆï¼ğŸµ";
        startBtn.disabled = false;
        nextBtn.disabled = true;
        return;
    }
    let remain = times[currentIndex];
    countdownEl.textContent = `ç¬¬${currentIndex+1}æ³¡ï¼š${remain} ç§’`;
    timer = setInterval(()=>{
        remain--;
        countdownEl.textContent = `ç¬¬${currentIndex+1}æ³¡ï¼š${remain} ç§’`;
        document.title = `ğŸµ ç¬¬${currentIndex+1}æ³¡ï¼š${remain}ç§’`;
        if(remain <= 0){
            clearInterval(timer);
            countdownEl.textContent = `ç¬¬${currentIndex+1}æ³¡å®Œæˆï¼Œè«‹å€’èŒ¶/æ³¨æ°´ ğŸµ`;
            alarm.currentTime = 0;
            alarm.play();
            nextBtn.disabled = false;
            let temp = currentIndex + 1;
            if(temp >= times.length)
            {
                manualSecInput.value = times[currentIndex] + parseInt(incrementInput.value);
            }
            else
            {
                manualSecInput.value = times[temp];
            }
        }
    },1000);
}

function continueNext(){
    currentIndex++;
    nextBtn.disabled = true;
    runCurrent();
}

function stopTimer(){
    clearInterval(timer);
    countdownEl.textContent="å·²åœæ­¢";
    startBtn.disabled = false;
    nextBtn.disabled = true;
}

// ===== åŒ¯å‡º/åŒ¯å…¥æ•´åˆæ³¨æ„äº‹é … =====
exportBtn.onclick = ()=>{
    const timesData = getTimes();
    const note = teaNoteInput.value;
    const data = {times: timesData, note: note};
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "tea_timer.json";
    a.click();
    URL.revokeObjectURL(url);
};

importFile.onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
        try{
            const obj = JSON.parse(reader.result);
            if(Array.isArray(obj.times)){
                fillTable(obj.times);
            }
            if(obj.note !== undefined){
                teaNoteInput.value = obj.note;
            }
        } catch(err){
            alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤");
        }
    };
    reader.readAsText(file);
};

presetSel.onchange = ()=> {
    if(presets[presetSel.value]) {
        fillTable(presets[presetSel.value]);
        teaNoteInput.value = teaNotes[presetSel.value] || "";
    }
};

addBatchBtn.onclick = () => {
    const inputs = tbody.querySelectorAll("input");
    const lastTime = inputs.length ? parseInt(inputs[inputs.length-1].value) || 0 : parseInt(firstInput.value) || 0;
    const increment = parseInt(incrementInput.value) || 0;
    const newTime = lastTime + increment;

    const tr = document.createElement("tr");
    const input = document.createElement("input");
    input.type = "number";
    input.value = newTime;
    input.min = 0;
    input.style.width = "70px";
    const newIndex = inputs.length;
    input.addEventListener("input", ()=>{
        if(times[newIndex] !== undefined){
            times[newIndex] = parseInt(input.value) || 0;
        }
    });
    tr.innerHTML = `<td>ç¬¬${newIndex+1}æ³¡</td>`;
    const td = document.createElement("td");
    td.appendChild(input);
    tr.appendChild(td);
    tbody.appendChild(tr);
    if(timer !== null || currentIndex < times.length){
        times.push(newTime);
        nextBtn.disabled = false;
    }
};

removeBatchBtn.onclick = () => {
    const rows = tbody.querySelectorAll("tr");
    if(rows.length > 1){
        tbody.removeChild(rows[rows.length-1]);
        times.pop();
    }
};

generateBtn.onclick = generate;
startBtn.onclick = startTimer;
nextBtn.onclick = continueNext;
stopBtn.onclick = stopTimer;

generate();

/* ======= æ‰‹å‹•è¨ˆæ™‚ç‰ˆæœ¬ ======= */
const manualStartBtn = document.getElementById("manualStart");
const manualStopBtn  = document.getElementById("manualStop");
const manualSecInput = document.getElementById("manualSec");
const manualCountdown = document.getElementById("manualCountdown");
let manualTimer = null;

function manualStart(){
    manualStop();
    let remain = parseInt(manualSecInput.value) || 0;
    if(remain <= 0){ manualCountdown.textContent = "è«‹è¼¸å…¥æ­£ç¢ºç§’æ•¸"; return; }
    manualCountdown.textContent = `å‰©é¤˜ï¼š${remain} ç§’`;
    manualTimer = setInterval(()=>{
        remain--;
        manualCountdown.textContent = `å‰©é¤˜ï¼š${remain} ç§’`;
        if(remain <= 0){
            clearInterval(manualTimer);
            manualCountdown.textContent = "å®Œæˆï¼ğŸµ";
            alarm.currentTime = 0;
            alarm.play();
        }
    },1000);
}
function manualStop(){
    clearInterval(manualTimer);
    manualCountdown.textContent = "å·²åœæ­¢";
}
manualStartBtn.onclick = manualStart;
manualStopBtn.onclick = manualStop;
</script>
</body>
</html>

